# Setup Guide

Full setup instructions for Rainflayer.

---

## Prerequisites

- Risk of Rain 2 (Steam)
- BepInEx 5.x ([download](https://github.com/BepInEx/BepInEx/releases))
- .NET SDK 6+ ([download](https://dotnet.microsoft.com/download))
- Python 3.10+
- Novita.ai API key ([get one](https://novita.ai))

---

## Step 1: Install BepInEx

Extract BepInEx into your RoR2 directory:

```
Risk of Rain 2/
  BepInEx/
    core/
    plugins/
    config/
  Risk of Rain 2.exe
```

Launch RoR2 once to let BepInEx generate its folder structure, then exit.

**Verify:** `BepInEx/LogOutput.log` should exist after launching.

---

## Step 2: Install HookGenPatcher (for MMHOOK)

Rainflayer needs `MMHOOK_RoR2.dll`, which is generated by HookGenPatcher.

1. Install [HookGenPatcher](https://thunderstore.io/package/RiskofThunder/HookGenPatcher/) via r2modman or manually
2. Launch RoR2 once — it generates `BepInEx/plugins/MMHOOK/MMHOOK_RoR2.dll`
3. Exit RoR2

---

## Step 3: Copy dependency DLLs

Copy these files into `mod/libs/` (create the folder if it doesn't exist):

**From `Risk of Rain 2_Data/Managed/`:**
- `Assembly-CSharp.dll`
- `RoR2.dll`
- `UnityEngine.dll`
- `UnityEngine.CoreModule.dll`
- `UnityEngine.PhysicsModule.dll`
- `UnityEngine.UI.dll`
- `KinematicCharacterController.dll`
- `HGCSharpUtils.dll`
- `LegacyResourcesAPI.dll`
- `com.unity.multiplayer-hlapi.Runtime.dll`

**From `BepInEx/core/`:**
- `BepInEx.Core.dll`
- `BepInEx.Unity.Mono.dll`
- `0Harmony.dll`
- `Mono.Cecil.dll`
- `MonoMod.Utils.dll`

**From `BepInEx/plugins/MMHOOK/`:**
- `MMHOOK_RoR2.dll`

---

## Step 4: Build the mod

```bash
cd mod
dotnet build -c Debug
```

Output: `mod/bin/Debug/netstandard2.1/Rainflayer.dll`

---

## Step 5: Install the mod

Copy the DLL into BepInEx plugins:

**Windows:**
```
copy mod\bin\Debug\netstandard2.1\Rainflayer.dll "C:\Program Files (x86)\Steam\steamapps\common\Risk of Rain 2\BepInEx\plugins\"
```

**macOS (CrossOver):**
```bash
cp mod/bin/Debug/netstandard2.1/Rainflayer.dll \
  "$HOME/Library/Application Support/CrossOver/Bottles/ROR2/drive_c/Program Files (x86)/Steam/steamapps/common/Risk of Rain 2/BepInEx/plugins/"
```

---

## Step 6: Set up Python

```bash
python -m venv venv
source venv/bin/activate     # Windows: venv\Scripts\activate
pip install -r requirements.txt
```

Create `.env` in the repo root:
```
NOVITA_API_KEY=your_key_here
```

---

## Step 7: Run

1. Launch RoR2 and start a solo run (any character)
2. Wait for the drop pod to land
3. In a terminal:

```bash
source venv/bin/activate
python -m brain.main
```

The brain waits up to 2 minutes for the mod to connect. You'll see:

```
  Game connected at 12:34:56
  Brain is running. Type a directive to influence its decisions.
directive>
```

---

## Mod Configuration

Config file is generated at `BepInEx/config/com.rainflayer.cfg` on first run:

```ini
[Rainflayer]
EnableAIControl = true
DebugMode = false
```

- `EnableAIControl` — set to `false` to play manually without removing the mod
- `DebugMode` — enables verbose logging in `BepInEx/LogOutput.log`

---

## Troubleshooting

### Mod doesn't load

- Verify `Rainflayer.dll` is in `BepInEx/plugins/` (not a subdirectory)
- Check `BepInEx/LogOutput.log` for errors
- Try running RoR2 as administrator (Windows)

### Socket won't connect

```bash
# Check nothing is using port 7777
lsof -ti:7777    # macOS/Linux
netstat -ano | findstr :7777   # Windows
```

- Make sure Python brain is started before the connection timeout
- Check firewall isn't blocking localhost connections

### Character doesn't move

- Verify `EnableAIControl = true` in mod config
- Enable `DebugMode = true` and check logs for `[AIController] [Movement]` lines
- Ensure `MMHOOK_RoR2.dll` is present in `mod/libs/` (required for hooks)

### LLM brain errors

- Confirm `NOVITA_API_KEY` is set: `echo $NOVITA_API_KEY`
- Check your Novita.ai account has credits
- The brain falls back to safe defaults (`STRATEGY:balanced, MODE:roam`) on any API error

### Log locations

| Component | Location |
|-----------|----------|
| Mod (C#) | `BepInEx/LogOutput.log` (filter for `[Rainflayer]`) |
| Brain (Python) | Console output |
