<h1 align="center">rainflayer</h1>

<p align="center">LLM-controlled Risk of Rain 2 via BepInEx mod + Python brain</p>

<p align="center">
  <a href="docs/SETUP.md">Setup</a> |
  <a href="docs/PROTOCOL.md">Protocol Reference</a> |
  <a href="docs/ARCHITECTURE.md">Architecture</a>
</p>

Rainflayer connects a large language model to Risk of Rain 2. A BepInEx mod exposes game state (enemies, inventory, objectives, interactables) over a local TCP socket. A Python brain queries that state every few seconds, feeds it to an LLM, and sends back strategic commands that the mod executes at 50 Hz — movement, aiming, skills, camera, all without simulating mouse or keyboard input.

Inspired by [Mindcraft](https://github.com/kolbytn/mindcraft) and [Mineflayer](https://github.com/PrismarineJS/mineflayer).

> [!NOTE]
> Rainflayer takes full control of your character. Launch a solo run and disable the mod config when you want to play normally (`EnableAIControl = false`).

---

## How It Works

```
┌─ Python Brain (Strategic, ~0.25 Hz) ────────────────┐
│  Llama 4 Maverick 17B via Novita.ai                  │
│  Reads game state → LLM → commands                   │
└────────────────────── ↕ TCP :7777 ───────────────────┘
┌─ BepInEx Mod (Tactical, 50 Hz) ─────────────────────┐
│  Intercepts InputBank + CameraRigController           │
│  Entity detection, pathfinding, skill execution       │
└──────────────────── Risk of Rain 2 ──────────────────┘
```

The brain runs a **directive REPL** — you can type natural-language goals while it plays:

```
directive> go activate the teleporter
directive> play more aggressively
directive> clear
directive> status
```

---

## Requirements

- **Risk of Rain 2** (Steam)
- **BepInEx 5.x** — [download](https://github.com/BepInEx/BepInEx/releases)
- **.NET SDK 6+** — [download](https://dotnet.microsoft.com/download) (for building the mod)
- **Python 3.10+**
- **Novita.ai API key** — [get one](https://novita.ai) (Llama 4 Maverick 17B, ~$0.10–0.50/hr)

---

## Setup

### 1. Install BepInEx

Extract BepInEx into your RoR2 directory so it looks like:

```
Risk of Rain 2/
  BepInEx/
    plugins/
    config/
  Risk of Rain 2.exe
```

Launch RoR2 once to let BepInEx initialize, then close it.

### 2. Copy the dependency DLLs

The mod needs RoR2 and BepInEx DLLs to compile. Copy these from your RoR2 installation into `mod/libs/`:

| File | Source |
|------|--------|
| `Assembly-CSharp.dll` | `Risk of Rain 2_Data/Managed/` |
| `RoR2.dll` | `Risk of Rain 2_Data/Managed/` |
| `BepInEx.Core.dll` | `BepInEx/core/` |
| `BepInEx.Unity.Mono.dll` | `BepInEx/core/` |
| `0Harmony.dll` | `BepInEx/core/` |
| `MMHOOK_RoR2.dll` | `BepInEx/plugins/MMHOOK/` (generated by HookGenPatcher) |
| `UnityEngine.dll` | `Risk of Rain 2_Data/Managed/` |
| `UnityEngine.CoreModule.dll` | `Risk of Rain 2_Data/Managed/` |
| `UnityEngine.PhysicsModule.dll` | `Risk of Rain 2_Data/Managed/` |
| `UnityEngine.UI.dll` | `Risk of Rain 2_Data/Managed/` |
| `KinematicCharacterController.dll` | `Risk of Rain 2_Data/Managed/` |
| `HGCSharpUtils.dll` | `Risk of Rain 2_Data/Managed/` |
| `LegacyResourcesAPI.dll` | `Risk of Rain 2_Data/Managed/` |
| `com.unity.multiplayer-hlapi.Runtime.dll` | `Risk of Rain 2_Data/Managed/` |
| `Mono.Cecil.dll` | `BepInEx/core/` |
| `MonoMod.Utils.dll` | `BepInEx/core/` |

> `MMHOOK_RoR2.dll` is generated by [HookGenPatcher](https://thunderstore.io/package/RiskofThunder/HookGenPatcher/) — install it via Thunderstore/r2modman and run RoR2 once.

### 3. Build and install the mod

```bash
cd mod
dotnet build -c Debug
```

Copy the output DLL to your BepInEx plugins folder:

```bash
# Windows
copy bin\Debug\netstandard2.1\Rainflayer.dll "C:\...\Risk of Rain 2\BepInEx\plugins\"

# macOS (CrossOver)
cp bin/Debug/netstandard2.1/Rainflayer.dll \
  "$HOME/Library/Application Support/CrossOver/Bottles/ROR2/drive_c/.../Risk of Rain 2/BepInEx/plugins/"
```

### 4. Set up the Python brain

```bash
python -m venv venv
source venv/bin/activate   # Windows: venv\Scripts\activate
pip install -r requirements.txt
```

Create a `.env` file:

```bash
NOVITA_API_KEY=your_novita_api_key_here
```

### 5. Run

Start RoR2, load into a run, then in a separate terminal:

```bash
source venv/bin/activate
python -m brain.main
```

The brain waits up to 2 minutes for the mod to connect. Once connected, it starts making decisions every 4 seconds and opens the directive REPL.

```
============================================================
  rainflayer — RoR2 LLM Brain Server
  Llama 4 Maverick 17B via Novita.ai
============================================================
  Game connected at 12:34:56

  Brain is running. Type a directive to influence its decisions.

directive> 
```

---

## Configuration

### Mod config

Generated at `BepInEx/config/com.rainflayer.cfg` after first run:

```ini
[Rainflayer]
EnableAIControl = true
DebugMode = false
```

Set `EnableAIControl = false` to play normally without removing the mod.

### Brain options

```bash
python -m brain.main --interval 4.0   # decision interval in seconds (default: 4.0)
python -m brain.main --timeout 120    # seconds to wait for game connection
```

---

## Commands

The LLM sends these commands to the mod. You can also use the directive REPL to steer strategy with natural language.

### Navigation & Interaction

| Command | Args | Effect |
|---------|------|--------|
| `FIND_AND_INTERACT` | `chest` | Navigate to nearest chest and open it |
| `FIND_AND_INTERACT` | `shrine` | Navigate to nearest shrine and use it |
| `FIND_AND_INTERACT` | `teleporter` | Navigate to teleporter and activate it |
| `GOTO` | `CANCEL` | Cancel current navigation |
| `BUY_SHOP_ITEM` | `Item Name` | Navigate to nearest shop and buy named item |

### Combat

| Command | Args | Effect |
|---------|------|--------|
| `STRATEGY` | `aggressive` | Close range (15m), strafing, high DPS |
| `STRATEGY` | `defensive` | Long range (25m), heavy kiting |
| `STRATEGY` | `balanced` | Medium range (20m), moderate skills |
| `STRATEGY` | `support` | Follow and protect allies |
| `MODE` | `roam` | Wander and auto-engage enemies |
| `MODE` | `combat` | Stay focused on enemies |
| `MODE` | `follow` | Follow nearest ally |
| `MODE` | `wait` | Stop all movement |

---

## Supported Characters

Combat logic is implemented for all survivors. Character-specific handling exists for:

- **Huntress** — can sprint while shooting
- **MUL-T** — special switches weapon mode instead of firing
- **Engineer** — turret placement with aim-confirm pulse
- **Captain** — Orbital Strike / Supply Drop with aim-confirm pulse

---

## Architecture

See [docs/ARCHITECTURE.md](docs/ARCHITECTURE.md) for a deep dive into:
- How InputBank and CameraRigController are hooked
- Multi-height raycasting for line-of-sight checks
- Thread-safe Unity ↔ socket communication
- Why direct API control was chosen over input simulation

See [docs/PROTOCOL.md](docs/PROTOCOL.md) for the full socket protocol reference.

---

## License

MIT
